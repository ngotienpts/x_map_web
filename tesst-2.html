<!DOCTYPE html>
<html lang="en">
<head>
    <title>Draw a line from A to B</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.7.1/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@5.7.1/dist/maplibre-gl.js'></script>
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
    </style>
</head>
<body>
<div id="map"></div>

<script>
   // Cấu hình chung
const CONFIG = {
    map: {
        initialLat: 20.978009,
        initialLon: 105.8121463,
        zoom: 16
    },
    marker: {
        color: '#FF0000'
    }
};

// Hàm lấy tọa độ từ các node ID
async function fetchNodeData(nodeIds) {
    const fetchPromises = nodeIds.map(async (nodeId) => {
        const jsonUrl = `https://api.xmap.vn/node/${nodeId}.json`;
        try {
            const response = await fetch(jsonUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.elements && data.elements.length > 0) {
                const node = data.elements[0];
                return [node.lon, node.lat];
            }
        } catch (error) {
            console.error(`Lỗi khi tải dữ liệu cho node ${nodeId}:`, error);
            return null;
        }
    });

    const results = await Promise.all(fetchPromises);
    return results.filter(coords => coords !== null);
}

// Hàm xử lý trường hợp URL có tham số 'nodes'
async function handleNodesURL(map) {
    const url = new URL(window.location.href);
    const nodesParam = url.searchParams.get('nodes');
    const nodeIds = nodesParam ? nodesParam.split(',') : [];

    const realRouteCoordinates = await fetchNodeData(nodeIds);
    console.log('Tọa độ các node đã lấy từ API:', realRouteCoordinates);

    if (realRouteCoordinates.length < 2) {
        console.warn('Không đủ tọa độ để vẽ đường đi.');
        return;
    }

    // Lấy tọa độ của node đầu tiên để đặt center ban đầu
    const firstNodeCoords = realRouteCoordinates[0];
    map.setCenter(firstNodeCoords);

    map.addSource('route', {
        'type': 'geojson',
        'data': {
            'type': 'Feature',
            'properties': {},
            'geometry': {
                'type': 'LineString',
                'coordinates': realRouteCoordinates
            }
        }
    });

    map.addLayer({
        'id': 'route-line',
        'type': 'line',
        'source': 'route',
        'layout': {
            'line-join': 'round',
            'line-cap': 'round'
        },
        'paint': {
            'line-color': '#ed6498',
            'line-width': 5,
            'line-opacity': 0.8
        }
    });
}

// Hàm xử lý trường hợp URL có tham số 'marker'
function handleMarkerURL(map) {
    const params = new URLSearchParams(window.location.search);
    const markerParam = params.get("marker");

    if (markerParam) {
        const coords = markerParam.split(",").map(Number);
        if (coords.length === 2 && !coords.some(isNaN)) {
            const [lat, lon] = coords;
            map.setCenter([lon, lat]);
            map.setZoom(CONFIG.map.zoom);

            new maplibregl.Marker({
                    color: CONFIG.marker.color
                })
                .setLngLat([lon, lat])
                .addTo(map);
        }
    }
}

// Hàm khởi tạo ứng dụng chính
async function initializeApp() {
    const params = new URLSearchParams(window.location.search);
    const hasNodesParam = params.has('nodes');
    const hasMarkerParam = params.has('marker');
    let initialCenter;
    let initialZoom;

    // Xác định tọa độ và zoom ban đầu dựa trên URL
    if (hasMarkerParam) {
        const markerParam = params.get("marker");
        const coords = markerParam.split(",").map(Number);
        if (coords.length === 2 && !coords.some(isNaN)) {
            initialCenter = [coords[1], coords[0]];
            initialZoom = CONFIG.map.zoom;
        }
    } else if (hasNodesParam) {
        // Tạm thời để một center mặc định. Center thực sự sẽ được thiết lập sau khi lấy được node đầu tiên.
        initialCenter = [CONFIG.map.initialLon, CONFIG.map.initialLat];
        initialZoom = 13;
    } else {
        // Trường hợp không có tham số URL
        initialCenter = [CONFIG.map.initialLon, CONFIG.map.initialLat];
        initialZoom = CONFIG.map.zoom;
    }
    
    // Khởi tạo bản đồ
    const map = new maplibregl.Map({
        container: 'map',
        style: 'https://xmap.vn/lib/dark-vietnam.json',
        center: initialCenter,
        zoom: initialZoom,
        pitch: 0,
        bearing: 0,
    });

    // Chờ bản đồ tải xong
    map.on('load', async () => {
        if (hasNodesParam) {
            await handleNodesURL(map);
        } else if (hasMarkerParam) {
            handleMarkerURL(map);
        }
    });
}

// Bắt đầu ứng dụng
initializeApp();
</script>
</body>
</html>